<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrainBox Med - Medical Simulator: Train Your Brain. Master Medicine</title>
  <!-- Metadados essenciais -->
<meta name="description" content="BrainboxMed is an interactive multilingual medical quiz platform to train, review, and master Intensive Care Medicine.">
<meta name="keywords" content="medicina, medicine, simulado, mock tests, intensivismo, intensive care, intensive care medicine, critical care, critical care medicine, quiz m√©dico, medical quiz, brainboxmed, usmle, medicina intensiva, ECMO, neuro, neurology, neurosurgery, cardio, cardiology, infecto, infectious diseases, ventilation, mechanical ventilation, nephrology, nephro, nefrologia, sedation, seda√ß√£o, anestesia, anesthesia, pediatria, pediatrics, urg√™ncia, emerg√™ncia, emergency medicine, urg√™ncia e emerg√™ncia, nutritional therapy, terapia nutricional, terapia intensiva, intensive therapy, pancreatitis, pancreatite, dialysis, di√°lise, non-invasive ventilation">
<meta name="author" content="BrainboxMed Team">
<meta name="language" content="en">

<!-- Metadados Open Graph para compartilhamento -->
<meta property="og:title" content="BrainboxMed ‚Äì Train your brain. Master medicine.">
<meta property="og:description" content="Simulados interativos e multil√≠ngues para dominar medicina intensiva. Din√¢mico e focado na pr√°tica.">
<meta property="og:image" content="https://seudominio.com/assets/img/preview.png"> <!-- ou omita por enquanto -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://seudominio.com"> <!-- ajustar futuramente -->

<!-- Compatibilidade e dispositivos -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Vari√°veis de cor para a barra de desempenho -->
  <style>
  :root {
  --color-primary: #3498db; /* azul padr√£o */
  --color-highlight: #1abc9c; /* verde-√°gua */
  --color-neutral: #7f8c8d; /* cinza neutro */
  --color-text: #333;
}  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">

</head>

<body oncontextmenu="return false;">
  <main>
    <div style="text-align: center; margin-bottom: 20px;">

<a href="#" onclick="confirmReturnHome(); return false;">
  <img src="logo-brainboxmed.png" alt="BrainboxMed Logo" loading="lazy" style="max-width: 250px; cursor: pointer;">
</a>
</div>
   <div style="text-align: center; margin-top: 10px;">
       <p style="font-family: 'Inter', sans-serif; color: #666; font-size: 14px;">
      Train your brain. Master medicine.
    </p>
  </div>

  <!-- Tela Inicial -->
<section id="home-screen" role="region" aria-label="Home screen">
    <p style="text-align: center; margin-bottom: 30px;">Intensive Care Medicine Simulator</p>
    
    <div class="mode-selector">
      <button class="mode-btn active" onclick="setMode('study')">Study Mode</button>
      <button class="mode-btn" onclick="setMode('exam')">Exam Mode</button>
    </div>
    
    <div id="exam-settings" style="display: none; text-align: center;">
      <label style="font-weight: bold;">Total Time (minutes): 
        <input type="number" id="exam-time" min="1" value="60" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </label>
     <label style="font-weight: bold; margin-left: 30px;">
  Number of Questions:
  <input type="number" id="exam-questions" min="10" max="100" value="50" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 80px;">
</label>
 
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn btn-primary" onclick="startQuiz()" style="background-color: var(--color-primary);">Start Quiz</button>
      <button class="btn btn-secondary" onclick="showConfig()">Settings</button>
    </div>
  </section>

  <!-- Tela de Configura√ß√µes -->
<section id="config-screen" role="region" aria-label="Configuration screen" style="display: none;">
    <h2 style="color: #005b94;">Settings</h2>
    <div style="margin: 20px 0;">
      <label for="language-selector" style="display: block; margin-bottom: 8px; font-weight: bold;">Language:</label>
      <select id="language-selector" style="padding: 8px; width: 100%; max-width: 200px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="en" selected>English</option>
        <option value="es">Espa√±ol</option>
        <option value="pt">Portugu√™s</option>
      </select>
    </div>

  <div style="margin-top: 20px;">
   <label style="font-weight: bold; display: block; margin-bottom: 8px;">Select Difficulty:</label>
   <label><input type="checkbox" class="difficulty-filter" value="facil" checked> Easy</label><br>
   <label><input type="checkbox" class="difficulty-filter" value="moderada" checked> Medium</label><br>
   <label><input type="checkbox" class="difficulty-filter" value="dificil" checked> Hard</label><br>
   <label><input type="checkbox" class="difficulty-filter" value="muito_dificil" checked> Very Hard</label>
  </div>
    
    <div style="margin-top: 30px;">
      <button class="btn btn-secondary" onclick="saveConfig()">Save Settings</button>
      <button class="btn btn-secondary" onclick="hideConfig()">Cancel</button>
    </div>
  </section>

  <!-- Tela de Quest√µes -->
<section id="question-container" role="region" aria-label="Quiz interface" style="display: none;">
    <div id="timer-container" style="text-align: center; display: none;">
      <div id="timer">60:00</div>
      </div>

    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress" id="quiz-progress"></div>
      </div>
      <div class="progress-text" id="progress-text" style="display: none;"></div>
    </div>
    
    <h2 id="question-text" style="color: var(--color-primary);"></h2>
    <div id="options-container" class="options"></div>
    
    <div class="controls">
      <button id="prev-btn" class="btn btn-secondary" onclick="prevQuestion()">Previous</button>
      <button id="mark-btn" class="btn btn-highlight" onclick="togglePending()">Mark for Review</button>
      <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()">Next</button>
    </div>
    
    <div id="explanation" style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; display: none;">
      <h3 style="margin-top: 0; color: #005b94;">Explanation:</h3>
      <p id="explanation-text"></p>
    </div>
  </section>

  <!-- Tela de Resultado -->
<section id="result-screen" role="region" aria-label="Results report" style="display: none;">
  <div style="background-color: #ffffff; border: 2px solid var(--color-primary); padding: 24px; text-align: center; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
  <h2 id="report-title" style="margin: 0; font-size: 24px; color: var(--color-primary); font-weight: 600;">
    üìä PERFORMANCE REPORT
  </h2>
  <p style="margin-top: 10px; font-size: 14px; color: #555;">
    <span id="report-date"></span>
  </p>
  </div>

  <!-- Tela de Relat√≥rio de Quest√µes Pendentes -->
 <div id="pending-report-screen" style="display: none; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 20px 0;">
  <div class="report-header">
    <h2 id="pending-report-title">Questions for Review</h2>
    <p id="pending-report-date"></p>
  </div>
  <div id="pending-questions-container"></div>
  <ul id="pending-questions-list"></ul>
  <div class="report-controls" style="text-align: center; margin-top: 30px;">
  <button class="btn btn-secondary" onclick="backToMainReport()">‚Üê Back to Report</button>
  <button class="btn btn-secondary" onclick="confirmReturnHome()" style="background-color: var(--color-primary); margin-left: 10px;">
    ‚Üê Return to Home Page
  </button>
</div>

</div>

    <!-- Se√ß√£o 1: Performance Geral -->
    <div class="report-section" style="border-left-color: var(--color-primary);">
      <h3 id="general-performance-title" style="color: var(--color-primary);">‚ñå General Performance</h3>
      <div style="display: flex; align-items: center; gap: 20px;">
        <div style="flex: 1;">
          <p><span id="score-text">Score: 0/0</span></p>
          <p>Correct Percentage: <strong><span id="percentage">0</span>%</strong></p>
        </div>
        <div style="flex: 2;">
          <div style="height: 20px; background: #ecf0f1; border-radius: 10px; margin: 10px 0; position: relative;">
            <div id="score-bar" style="height: 100%; width: 0%; background: linear-gradient(to right, var(--color-highlight), var(--color-primary)); border-radius: 10px;"></div>
            <div style="position: absolute; top: -20px; left: 70%; border-left: 1px dashed #333; height: 25px; width: 1px;"></div>
          </div>
          <p style="text-align: center; margin-top: -10px; font-size: 0.8em; color: var(--color-text);">Expected average: 70%</p>
        </div>
      </div>
    </div>
    
    <!-- Se√ß√£o 2: An√°lise por Dom√≠nio -->
    <div class="report-section strength">
      <h3 id="strengths-title">‚ñå Strengths & Weaknesses</h3>
      <table>
        <thead>
          <tr>
            <th id="domain-header">Topic Area</th>
            <th style="text-align: center;" id="performance-header">% Correct</th>
            <th style="text-align: center;" id="status-header">Status</th>
          </tr>
        </thead>
        <tbody id="sw-body">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>
    </div>
    
    <!-- Se√ß√£o 3: An√°lise por Dificuldade -->
    <div class="report-section" style="border-left-color: var(--color-primary);">
  <h3 id="difficulty-title" style="color: var(--color-primary);">‚ñå Performance by Difficulty</h3>
      <table>
        <thead>
          <tr>
            <th id="level-header">Level</th>
            <th style="text-align: center;" id="questions-header">Questions</th>
            <th style="text-align: center;" id="correct-header">% Correct</th>
          </tr>
        </thead>
        <tbody id="difficulty-body">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>
    <div style="height: 30px;"></div>
    <hr style="border: none; border-top: 1px solid #ddd; margin: 30px auto; max-width: 80%;">
  </div>
    
    <!-- Gr√°fico de For√ßas e Fraquezas por Dificuldade -->
<div class="report-section" style="margin-top: 60px;">
  <h3 id="voronoi-title" style="text-align: center; color: var(--color-primary); margin-bottom: 30px;">
    üìä Strengths and Weaknesses by Difficulty
  </h3>

  <div id="voronoi-chart" style="width: 100%; max-width: 900px; height: 500px; margin: 0 auto;"></div>

  <div id="voronoi-legend" style="text-align: center; margin-top: 20px; font-size: 14px; color: #555;">
    <p><strong>üü¶ Strengths (Top)</strong> ‚Äì Size ‚àù % of correct answers per difficulty</p>
    <p><strong>üü• Weaknesses (Bottom)</strong> ‚Äì Size ‚àù % of incorrect answers per difficulty</p>
  </div>

  <div id="voronoi-topics" style="margin-top: 40px;">
  <h4 id="voronoi-topics-title" style="text-align: center; color: var(--color-primary); margin-bottom: 20px;">
    üß© Detailed Accuracy by Topic
  </h4>
 <div id="voronoi-topics-content" style="width: 100%; height: 600px; margin: 0 auto;"></div>
</div>

</div>
    <!-- Se√ß√£o 4: Plano de Estudo Padronizado -->
  <div class="report-section" style="border: 2px dashed var(--color-highlight); background-color: #ffffff; border-radius: 12px; padding: 24px; margin-top: 40px;">
  
  <h3 id="performance-graph-title" style="color: var(--color-primary); text-align: center; margin-top: 60px; margin-bottom: 30px;">
  üìä Detailed Performance by Area and Topic
  </h3>
  <div id="performance-chart" style="max-width: 100%; margin: 0 auto 50px auto;"></div>
  
  <h3 id="recommendations-title" style="color: var(--color-highlight); font-size: 22px; margin-bottom: 20px;">
  üìö Study Recommendations Based on Your Most Missed Topics
  </h3>
  <div id="study-recommendations" style="font-size: 15px; color: #333; line-height: 1.6;"></div>
     
   <!-- Se√ß√£o 5: Quest√µes Pendentes -->
  <div id="review-box" class="report-section" style="text-align: center; padding: 30px; background-color: #ffffff; border: 2px dashed var(--color-highlight); border-radius: 12px; margin-top: 40px;">
    <h3 id="review-redirect-title" style="font-size: 26px; font-weight: 600; color: var(--color-highlight); margin-bottom: 20px;">
    üìò Review Your Answers
    </h3>
  <p id="review-redirect-subtitle" style="font-size: 16px; color: #555; margin-bottom: 25px;">
    See all your responses with explanations and learn from each one.
  </p>
  <button onclick="window.location.href='review.html'" style="
    font-size: 18px;
    padding: 14px 32px;
    background-color: var(--color-highlight);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: background 0.3s;
  ">
    üìã <span id="review-redirect-button">Open Detailed Review</span>
  </button>
</div>

<!-- Bot√µes de Controle -->
 <div id="pending-questions-section"></div>
<div style="text-align: center; margin-top: 30px;">
  <button id="restart-btn" class="btn btn-secondary" onclick="restartQuiz()">Restart Test</button>
  <button id="print-btn" class="btn btn-secondary" style="background-color: var(--color-neutral);" onclick="window.print()"> Print Report</button>
  <button id="back-home-btn" class="btn btn-secondary" onclick="confirmReturnHome()" style="background-color: var(--color-primary); margin-left: 10px;">
  ‚Üê Voltar √† P√°gina Inicial
</button>
<div style="text-align: center; margin-top: 20px;">
  <button id="final-report-btn" class="btn btn-highlight" onclick="window.location.href='relatoriofinal.html'" style="font-size: 16px;">
    üìä View Final Report
  </button>
</div>
</div>
</section>
</main>
<p id="legal-warning" style="text-align:center; font-size: 12px; color: #999; margin-top: 40px;"></p>
     <!-- Scripts -->
<script src="Question-Bank/banco-questoes.js" defer></script>
<script src="Question-Bank/Neuro01.js" defer></script>
<script src="Question-Bank/Neuro02.js" defer></script>
<script src="Question-Bank/Neuro03.js" defer></script>
<script src="Question-Bank/Neuro04.js" defer></script>
<script src="relatorio.js" defer></script>
<script src="assets/js/script.js" defer></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const lang = localStorage.getItem("selectedLanguage") || "en";

  const reviewTexts = {
    en: {
      title: "üìò Review Your Answers",
      subtitle: "See all your responses with explanations and learn from each one.",
      button: "Open Detailed Review"
    },
    pt: {
      title: "üìò Revisar suas Respostas",
      subtitle: "Veja todas as suas respostas com explica√ß√µes e aprenda com cada uma.",
      button: "Abrir Revis√£o Detalhada"
    },
    es: {
      title: "üìò Revisar tus Respuestas",
      subtitle: "Consulta todas tus respuestas con explicaciones y aprende de cada una.",
      button: "Abrir Revisi√≥n Detallada"
    }
  };

  const t = reviewTexts[lang] || reviewTexts["en"];
  document.getElementById("review-redirect-title").textContent = t.title;
  document.getElementById("review-redirect-subtitle").textContent = t.subtitle;
  document.getElementById("review-redirect-button").textContent = t.button;
  
  const homeTexts = {
  pt: "‚Üê Voltar √† P√°gina Inicial",
  en: "‚Üê Return to Home Page",
  es: "‚Üê Volver a la P√°gina Principal"
  };
  document.getElementById("back-home-btn").textContent = homeTexts[lang] || homeTexts.en;

  const restartTexts = {
  pt: "üîÅ Refazer Teste",
  en: "üîÅ Restart Test",
  es: "üîÅ Reiniciar Prueba"
  };
  document.getElementById("restart-btn").textContent = restartTexts[lang] || restartTexts.en;
  
  const printTexts = {
    pt: "üñ®Ô∏è Imprimir Relat√≥rio",
    en: "üñ®Ô∏è Print Report",
    es: "üñ®Ô∏è Imprimir Informe"
  };
  document.getElementById("print-btn").textContent = printTexts[lang] || printTexts.en;
  
  const graphTitles = {
  pt: "üìä Desempenho Detalhado por √Årea e T√≥pico",
  en: "üìä Detailed Performance by Area and Topic",
  es: "üìä Rendimiento Detallado por √Årea y Tema"
  };
  document.getElementById("performance-graph-title").textContent = graphTitles[lang] || graphTitles.en;
  
  const voronoiTitles = {
  pt: "üìä Desempenho por Dificuldade ‚Äì For√ßas e Fraquezas",
  en: "üìä Strengths and Weaknesses by Difficulty",
  es: "üìä Rendimiento por Dificultad ‚Äì Fortalezas y Debilidades"
  };
  document.getElementById("voronoi-title").textContent = voronoiTitles[lang] || voronoiTitles.en;

  const voronoiLegend = {
  pt: `
    <p><strong>üü¶ For√ßas (Acima)</strong> ‚Äì Tamanho proporcional √† % de acertos por n√≠vel de dificuldade</p>
    <p><strong>üü• Fraquezas (Abaixo)</strong> ‚Äì Tamanho proporcional √† % de erros por n√≠vel de dificuldade</p>
  `,
  en: `
    <p><strong>üü¶ Strengths (Top)</strong> ‚Äì Size ‚àù % of correct answers per difficulty</p>
    <p><strong>üü• Weaknesses (Bottom)</strong> ‚Äì Size ‚àù % of incorrect answers per difficulty</p>
  `,
  es: `
    <p><strong>üü¶ Fortalezas (Arriba)</strong> ‚Äì Tama√±o ‚àù % de respuestas correctas por nivel de dificultad</p>
    <p><strong>üü• Debilidades (Abajo)</strong> ‚Äì Tama√±o ‚àù % de errores por nivel de dificultad</p>
  `
  };
  document.getElementById("voronoi-legend").innerHTML = voronoiLegend[lang] || voronoiLegend.en;

  const insightsTitles = {
  pt: "üîç Informa√ß√µes Adicionais",
  en: "üîç Additional Insights",
  es: "üîç Informaci√≥n Adicional"
  };
  const insightsTitleEl = document.getElementById("study-insights-title");
  if (insightsTitleEl) insightsTitleEl.textContent = insightsTitles[lang] || insightsTitles.en;

  const legalWarnings = {
  pt: "Este relat√≥rio √© apenas para fins educacionais. N√£o substitui orienta√ß√£o m√©dica ou institucional.",
  en: "This report is for educational purposes only. It does not replace medical or institutional guidance.",
  es: "Este informe es solo con fines educativos. No reemplaza la orientaci√≥n m√©dica o institucional."
  };
  document.getElementById("legal-warning").textContent = legalWarnings[lang] || legalWarnings.en;

});
</script>
<script>
function drawVoronoiDifficultyChart(questions, answers, lang = "en") {
  const diffLabels = {
    facil: { pt: "F√°cil", en: "Easy", es: "F√°cil" },
    moderada: { pt: "Moderada", en: "Moderate", es: "Moderada" },
    dificil: { pt: "Dif√≠cil", en: "Hard", es: "Dif√≠cil" },
    muito_dificil: { pt: "Muito Dif√≠cil", en: "Very Hard", es: "Muy Dif√≠cil" }
  };

  const stats = {
    facil: { total: 0, correct: 0 },
    moderada: { total: 0, correct: 0 },
    dificil: { total: 0, correct: 0 },
    muito_dificil: { total: 0, correct: 0 }
  };

  questions.forEach(q => {
    const nivel = q.nivel;
    if (!nivel || !stats[nivel]) return;
    stats[nivel].total++;
    if (answers[q.id] === q.correta) stats[nivel].correct++;
  });

  const labels = [];
  const parents = [];
  const values = [];
  const colors = [];

  const colorStrength = "rgba(52, 152, 219, 0.8)";
  const colorWeakness = "rgba(231, 76, 60, 0.8)";

  Object.entries(stats).forEach(([nivel, { total, correct }]) => {
    const incorrect = total - correct;
    const label = diffLabels[nivel][lang];

    if (correct > 0) {
      labels.push(`${label} ‚úÖ`);
      parents.push("Strengths");
      values.push(correct);
      colors.push(colorStrength);
    }

    if (incorrect > 0) {
      labels.push(`${label} ‚ùå`);
      parents.push("Weaknesses");
      values.push(incorrect);
      colors.push(colorWeakness);
    }
  });

  // Adiciona os grupos principais
  const totalStrengths = values
  .filter((_, i) => parents[i] === "Strengths")
  .reduce((a, b) => a + b, 0);

  const totalWeaknesses = values
  .filter((_, i) => parents[i] === "Weaknesses")
  .reduce((a, b) => a + b, 0);

  labels.unshift("Strengths", "Weaknesses");
  parents.unshift("", "");
  values.unshift(totalStrengths, totalWeaknesses);
  colors.unshift("lightblue", "lightcoral");

  const data = [{
    type: "treemap",
    labels,
    parents,
    values,
    marker: {
      colors,
      line: { width: 1 }
    },
    textinfo: "label+value",
    branchvalues: "total"
  }];

  const layout = {
    height: 500,
    margin: { t: 30, l: 0, r: 0, b: 0 }
  };

  Plotly.newPlot("voronoi-chart", data, layout, { responsive: true });
}
 </script>
 <script>
  function drawSankeyAccuracyChart(questions, answers, lang = "en") {
    const statusLabels = {
    en: { correct: "‚úÖ Correct", incorrect: "‚ùå Incorrect" },
    pt: { correct: "‚úÖ Corretas", incorrect: "‚ùå Incorretas" },
    es: { correct: "‚úÖ Correctas", incorrect: "‚ùå Incorrectas" }
    };
    const areaLabels = {
     neuro: { pt: "üß† Neuro", en: "üß† Neuro", es: "üß† Neuro" },
     cardio: { pt: "‚ù§Ô∏è Cardio", en: "‚ù§Ô∏è Cardio", es: "‚ù§Ô∏è Cardio" },
     infecto: { pt: "ü¶† Infecto", en: "ü¶† Infectious", es: "ü¶† Infecciosas" },
     respiratorio: { pt: "ü´Å Respirat√≥rio", en: "ü´Å Respiratory", es: "ü´Å Respiratorio" },
     renal: { pt: "ü©∏ Renal", en: "ü©∏ Renal", es: "ü©∏ Renal" },
     general: { pt: "üìö Geral", en: "üìö General", es: "üìö General" }
    };
    const labelsByLang = statusLabels[lang] || statusLabels["en"];
    const areaTopicStats = {};
    const labelIndexMap = {};
    const nodes = [];
    const links = [];

  // Etapa 1: Agrupar dados por √°rea e t√≥pico separando acertos e erros
  questions.forEach(q => {
    const area = q.area || "General";
    const topics = Array.isArray(q.topic) ? q.topic : [q.topic || "General"];
    const correct = answers[q.id] === q.correta;
    const status = correct ? "Correct" : "Incorrect";

    topics.forEach(topic => {
      const key = `${status}|${area}|${topic}`;
      if (!areaTopicStats[key]) areaTopicStats[key] = { status, area, topic, count: 0 };
      areaTopicStats[key].count++;
    });
  });

  // Etapa 2: Pegar os 10 t√≥picos mais acertados e mais errados
  const statsArray = Object.values(areaTopicStats);
  const topCorrect = statsArray.filter(d => d.status === "Correct")
    .sort((a, b) => b.count - a.count).slice(0, 10);

  const topIncorrect = statsArray.filter(d => d.status === "Incorrect")
    .sort((a, b) => b.count - a.count).slice(0, 10);

  const topStats = [...topCorrect, ...topIncorrect];

  // Fun√ß√£o auxiliar para adicionar n√≥s
  function getLabelIndex(label) {
    if (!(label in labelIndexMap)) {
      labelIndexMap[label] = nodes.length;
      nodes.push({ name: label });
    }
    return labelIndexMap[label];
  }

  // Etapa 3: Montar os links e n√≥s com cores adaptadas
  topStats.forEach(({ status, area, topic, count }) => {
    const isCorrect = status === "Correct";
    const statusLabel = isCorrect ? labelsByLang.correct : labelsByLang.incorrect;
    const topicLabel = `${topic} ${isCorrect ? "‚úÖ" : "‚ùå"}`;

    const source1 = getLabelIndex(statusLabel);
    const areaLabel = areaLabels[area.toLowerCase()]?.[lang] || area;
    const source2 = getLabelIndex(areaLabel);
    const target = getLabelIndex(topicLabel);

    // status ‚Üí √°rea
    links.push({ source: source1, target: source2, value: count });

    // √°rea ‚Üí t√≥pico
    links.push({ source: source2, target: target, value: count });
  });

  const colorCorrect = "rgba(52, 152, 219, 0.8)";
  const colorIncorrect = "rgba(231, 76, 60, 0.8)";
  const colorLightCorrect = "rgba(52, 152, 219, 0.25)";
  const colorLightIncorrect = "rgba(231, 76, 60, 0.25)";
  const colorArea = "#cccccc";

  const data = [{
    type: "sankey",
    orientation: "h",
    node: {
      pad: 15,
      thickness: 20,
      line: { color: "black", width: 0.5 },
      label: nodes.map(n => n.name),
      color: nodes.map(n => {
        if (n.name === "‚úÖ Correct") return colorCorrect;
        if (n.name === "‚ùå Incorrect") return colorIncorrect;
        if (n.name.endsWith("‚úÖ")) return colorLightCorrect;
        if (n.name.endsWith("‚ùå")) return colorLightIncorrect;
        return colorArea;
      })
    },
    link: {
     source: links.map(l => l.source),
     target: links.map(l => l.target),
     value: links.map(l => l.value),
     color: links.map(l => {
      const srcLabel = nodes[l.source].name;
      if (srcLabel.startsWith("‚úÖ")) return colorCorrect;
      if (srcLabel.startsWith("‚ùå")) return colorIncorrect;
      return "rgba(160,160,160,0.3)";
     }),
     label: links.map(l => {
      const src = nodes[l.source].name;
      const tgt = nodes[l.target].name;
      return `${src} ‚Üí ${tgt}: ${l.value}`;
     })
    }

  }];

  const estimatedHeight = Math.max(400, nodes.length * 28);

  const layout = {
  title: "Topic Accuracy Flow",
  font: { size: 12 },
  height: estimatedHeight,
  margin: { t: 40, l: 10, r: 10, b: 10 }
  };


  Plotly.newPlot("voronoi-topics-content", data, layout, { responsive: true });
}
</script>

</body>
</html>