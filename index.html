<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrainBox Med - Medical Simulator: Train Your Brain. Master Medicine</title>
  <!-- Metadados essenciais -->
<meta name="description" content="BrainboxMed is an interactive multilingual medical quiz platform to train, review, and master Intensive Care Medicine.">
<meta name="keywords" content="medicina, medicine, simulado, mock tests, intensivismo, intensive care, intensive care medicine, critical care, critical care medicine, quiz mÃ©dico, medical quiz, brainboxmed, usmle, medicina intensiva, ECMO, neuro, neurology, neurosurgery, cardio, cardiology, infecto, infectious diseases, ventilation, mechanical ventilation, nephrology, nephro, nefrologia, sedation, sedaÃ§Ã£o, anestesia, anesthesia, pediatria, pediatrics, urgÃªncia, emergÃªncia, emergency medicine, urgÃªncia e emergÃªncia, nutritional therapy, terapia nutricional, terapia intensiva, intensive therapy, pancreatitis, pancreatite, dialysis, diÃ¡lise, non-invasive ventilation">
<meta name="author" content="BrainboxMed Team">
<meta name="language" content="en">

<!-- Metadados Open Graph para compartilhamento -->
<meta property="og:title" content="BrainboxMed â€“ Train your brain. Master medicine.">
<meta property="og:description" content="Simulados interativos e multilÃ­ngues para dominar medicina intensiva. DinÃ¢mico e focado na prÃ¡tica.">
<meta property="og:image" content="https://seudominio.com/assets/img/preview.png"> <!-- ou omita por enquanto -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://seudominio.com"> <!-- ajustar futuramente -->

<!-- Compatibilidade e dispositivos -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- VariÃ¡veis de cor para a barra de desempenho -->
  <style>
  :root {
  --color-primary: #3498db; /* azul padrÃ£o */
  --color-highlight: #1abc9c; /* verde-Ã¡gua */
  --color-neutral: #7f8c8d; /* cinza neutro */
  --color-text: #333;
}  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">

</head>

<body oncontextmenu="return false;">
  <!-- Idioma e Logo BrainboxMed (cÃ³pia do landing.html) -->
<div style="position: absolute; top: 1rem; right: 1rem; z-index: 999;">
  <button onclick="changeLanguage('en')" style="background: none; border: none; cursor: pointer; margin-right: 8px;">
    <img src="flag-en.png" alt="English" style="height: 48px; width: auto;" />
  </button>
    <button onclick="changeLanguage('es')" style="background: none; border: none; cursor: pointer;">
    <img src="flag-es.png" alt="EspaÃ±ol" style="height: 48px; width: auto;" />
  </button>
  <button onclick="changeLanguage('pt')" style="background: none; border: none; cursor: pointer; margin-right: 8px;">
    <img src="flag-pt.png" alt="PortuguÃªs" style="height: 48px; width: auto;" />
  </button>
</div>

<div style="width: 100%; background-color: #f3f0eb; display: flex; justify-content: center; align-items: center; padding: 48px 0; margin-top: 32px;">
  <img src="logo-brainboxmed-cube.png" alt="BrainboxMed Icon" style="height: 120px; width: auto; margin-right: 32px;" />
  <img src="logo-brainboxmed-name.png" alt="BrainboxMed Text Logo" style="height: 120px; width: auto;" />
</div>

<p style="font-family: 'Inter', sans-serif; font-size: 1.1rem; color: #333; text-align: center; margin: 1.5rem auto 2rem auto;">
  Train your brain. Master medicine.
</p>
  <main>
  <!-- Tela Inicial -->
<section id="home-screen" role="region" aria-label="Home screen">
    <p style="text-align: center; margin-bottom: 30px;">Intensive Care Medicine Simulator</p>
    
    <div class="mode-selector">
      <button id="btn-study" class="mode-btn active" onclick="setMode('study')">Study Mode</button>
      <button id="btn-exam" class="mode-btn" onclick="setMode('exam')">Exam Mode</button>
    </div>
    
    <div id="exam-settings" style="display: none; text-align: center;">
      <label style="font-weight: bold;">Total Time (minutes): 
        <input type="number" id="exam-time" min="1" value="60" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </label>
     <label style="font-weight: bold; margin-left: 30px;">
  Number of Questions:
  <input type="number" id="exam-questions" min="10" max="100" value="50" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 80px;">
</label>
 
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button id="btn-start" class="btn btn-primary" onclick="startQuiz()" style="background-color: var(--color-primary);">Start Quiz </button>
      <button id="btn-settings" class="btn btn-secondary" onclick="showConfig()">Settings</button>
    </div>
  </section>

  <!-- Tela de ConfiguraÃ§Ãµes -->
<section id="config-screen" role="region" aria-label="Configuration screen" style="display: none;">
    <h2 id="settings-title" style="color: #005b94;">Settings</h2>
    <div style="margin: 20px 0;">
    </div>
    <!-- Checkboxes de Dificuldade -->
  <div style="margin-top: 20px;">
    <label id="label-select-difficulty" style="font-weight: bold; display: block; margin-bottom: 8px;">Select Difficulty:</label>
    <label id="label-easy"><input type="checkbox" class="difficulty-filter" value="facil" checked> Easy</label><br>
    <label id="label-medium"><input type="checkbox" class="difficulty-filter" value="moderada" checked> Medium</label><br>
    <label id="label-hard"><input type="checkbox" class="difficulty-filter" value="dificil" checked> Hard</label><br>
    <label id="label-very-hard"><input type="checkbox" class="difficulty-filter" value="muito_dificil" checked> Very Hard</label>
  </div>
  <!-- Checkboxes de Especialidade -->
    <div style="margin-top: 30px;">
      <label id="label-select-specialty" style="font-weight: bold; display: block; margin-bottom: 8px;">Select Specialty:</label>
      <div id="specialty-checkboxes"></div>
    </div>

    <div style="margin-top: 30px;">
      <label id="label-specialty-mode" for="specialty-mode" style="font-weight: bold;">Filter Mode for Specialty:</label>
      <select id="specialty-mode" style="margin-left: 10px; padding: 6px 10px; border-radius: 4px;">
      <option value="inclusive">Match any selected specialty</option>
      <option value="strict">Only match questions with all selected specialties</option>
      </select>
    </div>

    <div style="margin-top: 30px;">
      <button id="btn-save-config" class="btn btn-secondary" onclick="saveConfig()">Save Settings</button>
      <button id="btn-cancel-config" class="btn btn-secondary" onclick="hideConfig()">Cancel</button>
    </div>
  </section>

  <!-- Tela de QuestÃµes -->
<section id="question-container" role="region" aria-label="Quiz interface" style="display: none;">
    <div id="timer-container" style="text-align: center; display: none;">
      <div id="timer">60:00</div>
    </div>
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress" id="quiz-progress"></div>
      </div>
      <div class="progress-text" id="progress-text" style="display: none;"></div>
    </div>
    <h2 id="question-text" style="color: var(--color-primary);"></h2>
    <div id="options-container" class="options"></div>
    <div id="controls-container" class="controls" style="
            display: none;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            flex-direction: row;">
        <button id="prev-btn" class="btn btn-secondary" style="min-width: 100px;" onclick="prevQuestion()">Previous</button>
        <button id="mark-btn" class="btn btn-highlight" style="min-width: 140px;" onclick="togglePending()">Mark for Review</button>
        <button id="next-btn" class="btn btn-primary" style="min-width: 100px;" onclick="nextQuestion()">Next</button>
    </div>

    <div id="explanation" style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; display: none;">
      <h3 style="margin-top: 0; color: #005b94;">Explanation:</h3>
      <p id="explanation-text"></p>
    </div>
  </section>

  <!-- Tela de Resultado -->
<section id="result-screen" role="region" aria-label="Results report" style="display: none;">
  <div style="background-color: #ffffff; border: 2px solid var(--color-primary); padding: 24px; text-align: center; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
  <h2 id="report-title" style="margin: 0; font-size: 24px; color: var(--color-primary); font-weight: 600;">
    ğŸ“Š PERFORMANCE REPORT
  </h2>
  <p style="margin-top: 10px; font-size: 14px; color: #555;">
    <span id="report-date"></span>
  </p>
  </div>

  <!-- Tela de RelatÃ³rio de QuestÃµes Pendentes -->
 <div id="pending-report-screen" style="display: none; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 20px 0;">
  <div class="report-header">
    <h2 id="pending-report-title">Questions for Review</h2>
    <p id="pending-report-date"></p>
  </div>
  <div id="pending-questions-container"></div>
  <ul id="pending-questions-list"></ul>
  <div class="report-controls" style="text-align: center; margin-top: 30px;">
  <button class="btn btn-secondary" onclick="backToMainReport()">â† Back to Report</button>
  <button class="btn btn-secondary" onclick="confirmReturnHome()" style="background-color: var(--color-primary); margin-left: 10px;">
    â† Return to Home Page
  </button>
</div>

</div>

    <!-- SeÃ§Ã£o 1: Performance Geral -->
    <div class="report-section" style="border-left-color: var(--color-primary);">
      <h3 id="general-performance-title" style="color: var(--color-primary);">â–Œ General Performance</h3>
      <div style="display: flex; align-items: center; gap: 20px;">
        <div style="flex: 1;">
          <p><span id="score-text">Score: 0/0</span></p>
          <p>Correct Percentage: <strong><span id="percentage">0</span>%</strong></p>
        </div>
        <div style="flex: 2;">
          <div style="height: 20px; background: #ecf0f1; border-radius: 10px; margin: 10px 0; position: relative;">
            <div id="score-bar" style="height: 100%; width: 0%; background: linear-gradient(to right, var(--color-highlight), var(--color-primary)); border-radius: 10px;"></div>
            <div style="position: absolute; top: -20px; left: 70%; border-left: 1px dashed #333; height: 25px; width: 1px;"></div>
          </div>
          <p style="text-align: center; margin-top: -10px; font-size: 0.8em; color: var(--color-text);">Expected average: 70%</p>
        </div>
      </div>
    </div>
    
    <!-- SeÃ§Ã£o 2: AnÃ¡lise por DomÃ­nio -->
    <div class="report-section strength">
      <h3 id="strengths-title">â–Œ Strengths & Weaknesses</h3>
      <table>
        <thead>
          <tr>
            <th id="domain-header">Topic Area</th>
            <th style="text-align: center;" id="performance-header">% Correct</th>
            <th style="text-align: center;" id="status-header">Status</th>
          </tr>
        </thead>
        <tbody id="sw-body">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>
    </div>
    
    <!-- SeÃ§Ã£o 3: AnÃ¡lise por Dificuldade -->
    <div class="report-section" style="border-left-color: var(--color-primary);">
  <h3 id="difficulty-title" style="color: var(--color-primary);">â–Œ Performance by Difficulty</h3>
      <table>
        <thead>
          <tr>
            <th id="level-header">Level</th>
            <th style="text-align: center;" id="questions-header">Questions</th>
            <th style="text-align: center;" id="correct-header">% Correct</th>
          </tr>
        </thead>
        <tbody id="difficulty-body">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>
  <canvas id="chart-dificuldade" style="margin: 0 auto; display: none;"></canvas>
  </div>
        <!-- GrÃ¡fico de ForÃ§as e Fraquezas por Dificuldade -->
<div class="report-section" style="margin-top: 60px;">
  <h3 id="voronoi-title" style="text-align: center; color: var(--color-primary); margin-bottom: 30px;">
    ğŸ“Š Strengths and Weaknesses by Difficulty
  </h3>

  <div id="voronoi-chart" style="width: 100%; max-width: 900px; height: 500px; margin: 0 auto;"></div>

  <div id="voronoi-legend" style="text-align: center; margin-top: 20px; font-size: 14px; color: #555;">
    <p><strong>ğŸŸ¦ Strengths (Top)</strong> â€“ Size âˆ % of correct answers per difficulty</p>
    <p><strong>ğŸŸ¥ Weaknesses (Bottom)</strong> â€“ Size âˆ % of incorrect answers per difficulty</p>
  </div>

  <div id="voronoi-topics" style="margin-top: 40px;">
  <h4 id="voronoi-topics-title" style="text-align: center; color: var(--color-primary); margin-bottom: 20px;">
    ğŸ§© Detailed Accuracy by Topic
  </h4>
 <div id="voronoi-topics-content" style="width: 100%; height: 600px; margin: 0 auto;"></div>
</div>

</div>
    <!-- SeÃ§Ã£o 4: Plano de Estudo Padronizado -->
  <div class="report-section" style="border: 2px dashed var(--color-highlight); background-color: #ffffff; border-radius: 12px; padding: 24px; margin-top: 40px;">
  
  <h3 id="performance-graph-title" style="color: var(--color-primary); text-align: center; margin-top: 60px; margin-bottom: 30px;">
  ğŸ“Š Detailed Performance by Area and Topic
  </h3>
  <div id="performance-chart" style="max-width: 100%; margin: 0 auto 50px auto;"></div>
  
  <h3 id="recommendations-title" style="color: var(--color-highlight); font-size: 22px; margin-bottom: 20px;">
  ğŸ“š Study Recommendations Based on Your Most Missed Topics
  </h3>
  <div id="study-recommendations" style="font-size: 15px; color: #333; line-height: 1.6;"></div>
     
   <!-- SeÃ§Ã£o 5: QuestÃµes Pendentes -->
  <div id="review-box" class="report-section" style="text-align: center; padding: 30px; background-color: #ffffff; border: 2px dashed var(--color-highlight); border-radius: 12px; margin-top: 40px;">
    <h3 id="review-redirect-title" style="font-size: 26px; font-weight: 600; color: var(--color-highlight); margin-bottom: 20px;">
    ğŸ“˜ Review Your Answers
    </h3>
  <p id="review-redirect-subtitle" style="font-size: 16px; color: #555; margin-bottom: 25px;">
    See all your responses with explanations and learn from each one.
  </p>
  <button onclick="window.location.href='review.html'" style="
    font-size: 18px;
    padding: 14px 32px;
    background-color: var(--color-highlight);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: background 0.3s;
  ">
    ğŸ“‹ <span id="review-redirect-button">Open Detailed Review</span>
  </button>
</div>

<!-- BotÃµes de Controle -->
 <div id="pending-questions-section"></div>
<div style="text-align: center; margin-top: 30px;">
  <button id="restart-btn" class="btn btn-secondary" onclick="restartQuiz()">Restart Test</button>
  <button id="print-btn" class="btn btn-secondary" style="background-color: var(--color-neutral);" onclick="window.print()"> Print Report</button>
  <button id="back-home-btn" class="btn btn-secondary" onclick="confirmReturnHome()" style="background-color: var(--color-primary); margin-left: 10px;">
  â† Voltar Ã  PÃ¡gina Inicial
</button>
<div style="text-align: center; margin-top: 20px;">
  <button id="final-report-btn" class="btn btn-highlight" onclick="window.location.href='relatoriofinal.html'" style="font-size: 16px;">
    ğŸ“Š View Final Report
  </button>
</div>
</div>
</section>
</main>
<p id="legal-warning" style="text-align:center; font-size: 12px; color: #999; margin-top: 40px;"></p>
     <!-- Scripts -->
<script src="Question-Bank/banco-questoes.js" defer></script>
<script src="Question-Bank/Neuro01.js" defer></script>
<script src="Question-Bank/Neuro02.js" defer></script>
<script src="Question-Bank/Neuro03.js" defer></script>
<script src="Question-Bank/Neuro04.js" defer></script>
<script src="Question-Bank/Cardio01.js" defer></script>
<script src="Question-Bank/Cardio02.js" defer></script>
<script src="Question-Bank/Cardio03.js" defer></script>
<script src="Question-Bank/Cardio04.js" defer></script>
<script src="relatorio.js" defer></script>
<script src="assets/js/script.js" defer></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const reviewReturn = localStorage.getItem('reviewReturn');
   if (reviewReturn === 'true') {
   document.getElementById('home-screen').style.display = 'none';
   document.getElementById('result-screen').style.display = 'block';
   // Restaurar dados
   questionarioAtual = JSON.parse(localStorage.getItem('acumuladoQuestoes')) || [];
   userAnswers = JSON.parse(localStorage.getItem('acumuladoRespostas')) || {};
   let selectedLanguage = localStorage.getItem('selectedLanguage') || 'en';
   // Aguarda DOM e depois gera relatÃ³rio
   setTimeout(() => {
     generateUSMLEReport();
     updateUI();
   }, 100);
   localStorage.removeItem('reviewReturn');}
  const lang = localStorage.getItem("selectedLanguage") || "en";
  const reviewTexts = {
    en: {
      title: "ğŸ“˜ Review Your Answers",
      subtitle: "See all your responses with explanations and learn from each one.",
      button: "Open Detailed Review"
    },
    pt: {
      title: "ğŸ“˜ Revisar suas Respostas",
      subtitle: "Veja todas as suas respostas com explicaÃ§Ãµes e aprenda com cada uma.",
      button: "Abrir RevisÃ£o Detalhada"
    },
    es: {
      title: "ğŸ“˜ Revisar tus Respuestas",
      subtitle: "Consulta todas tus respuestas con explicaciones y aprende de cada una.",
      button: "Abrir RevisiÃ³n Detallada"
    }
  };

  const t = reviewTexts[lang] || reviewTexts["en"];
  document.getElementById("review-redirect-title").textContent = t.title;
  document.getElementById("review-redirect-subtitle").textContent = t.subtitle;
  document.getElementById("review-redirect-button").textContent = t.button;
  
  const homeTexts = {
  pt: "â† Voltar Ã  PÃ¡gina Inicial",
  en: "â† Return to Home Page",
  es: "â† Volver a la PÃ¡gina Principal"
  };
  document.getElementById("back-home-btn").textContent = homeTexts[lang] || homeTexts.en;

  const restartTexts = {
  pt: "ğŸ” Refazer Teste",
  en: "ğŸ” Restart Test",
  es: "ğŸ” Reiniciar Prueba"
  };
  document.getElementById("restart-btn").textContent = restartTexts[lang] || restartTexts.en;
  
  const printTexts = {
    pt: "ğŸ–¨ï¸ Imprimir RelatÃ³rio",
    en: "ğŸ–¨ï¸ Print Report",
    es: "ğŸ–¨ï¸ Imprimir Informe"
  };
  document.getElementById("print-btn").textContent = printTexts[lang] || printTexts.en;
  
  const graphTitles = {
  pt: "ğŸ“Š Desempenho Detalhado por Ãrea e TÃ³pico",
  en: "ğŸ“Š Detailed Performance by Area and Topic",
  es: "ğŸ“Š Rendimiento Detallado por Ãrea y Tema"
  };
  document.getElementById("performance-graph-title").textContent = graphTitles[lang] || graphTitles.en;
  
  const voronoiTitles = {
  pt: "ğŸ“Š Desempenho por Dificuldade â€“ ForÃ§as e Fraquezas",
  en: "ğŸ“Š Strengths and Weaknesses by Difficulty",
  es: "ğŸ“Š Rendimiento por Dificultad â€“ Fortalezas y Debilidades"
  };
  document.getElementById("voronoi-title").textContent = voronoiTitles[lang] || voronoiTitles.en;

  const voronoiLegend = {
  pt: `
    <p><strong>ğŸŸ¦ ForÃ§as (Acima)</strong> â€“ Tamanho proporcional Ã  % de acertos por nÃ­vel de dificuldade</p>
    <p><strong>ğŸŸ¥ Fraquezas (Abaixo)</strong> â€“ Tamanho proporcional Ã  % de erros por nÃ­vel de dificuldade</p>
  `,
  en: `
    <p><strong>ğŸŸ¦ Strengths (Top)</strong> â€“ Size âˆ % of correct answers per difficulty</p>
    <p><strong>ğŸŸ¥ Weaknesses (Bottom)</strong> â€“ Size âˆ % of incorrect answers per difficulty</p>
  `,
  es: `
    <p><strong>ğŸŸ¦ Fortalezas (Arriba)</strong> â€“ TamaÃ±o âˆ % de respuestas correctas por nivel de dificultad</p>
    <p><strong>ğŸŸ¥ Debilidades (Abajo)</strong> â€“ TamaÃ±o âˆ % de errores por nivel de dificultad</p>
  `
  };
  document.getElementById("voronoi-legend").innerHTML = voronoiLegend[lang] || voronoiLegend.en;

  const insightsTitles = {
  pt: "ğŸ” InformaÃ§Ãµes Adicionais",
  en: "ğŸ” Additional Insights",
  es: "ğŸ” InformaciÃ³n Adicional"
  };
  const insightsTitleEl = document.getElementById("study-insights-title");
  if (insightsTitleEl) insightsTitleEl.textContent = insightsTitles[lang] || insightsTitles.en;

  const legalWarnings = {
  pt: "Este relatÃ³rio Ã© apenas para fins educacionais. NÃ£o substitui orientaÃ§Ã£o mÃ©dica ou institucional.",
  en: "This report is for educational purposes only. It does not replace medical or institutional guidance.",
  es: "Este informe es solo con fines educativos. No reemplaza la orientaciÃ³n mÃ©dica o institucional."
  };
  document.getElementById("legal-warning").textContent = legalWarnings[lang] || legalWarnings.en;

});
</script>
<script>
function drawVoronoiDifficultyChart(questions, answers, lang = "en") {
  const diffLabels = {
    facil: { pt: "FÃ¡cil", en: "Easy", es: "FÃ¡cil" },
    moderada: { pt: "Moderada", en: "Moderate", es: "Moderada" },
    dificil: { pt: "DifÃ­cil", en: "Hard", es: "DifÃ­cil" },
    muito_dificil: { pt: "Muito DifÃ­cil", en: "Very Hard", es: "Muy DifÃ­cil" }
  };

  const stats = {
    facil: { total: 0, correct: 0 },
    moderada: { total: 0, correct: 0 },
    dificil: { total: 0, correct: 0 },
    muito_dificil: { total: 0, correct: 0 }
  };

  questions.forEach(q => {
    const nivel = q.nivel;
    if (!nivel || !stats[nivel]) return;
    stats[nivel].total++;
    if (answers[q.id] === q.correta) stats[nivel].correct++;
  });

  const labels = [];
  const parents = [];
  const values = [];
  const colors = [];

  const colorStrength = "rgba(52, 152, 219, 0.8)";
  const colorWeakness = "rgba(231, 76, 60, 0.8)";

  Object.entries(stats).forEach(([nivel, { total, correct }]) => {
    const incorrect = total - correct;
    const label = diffLabels[nivel][lang];

    if (correct > 0) {
      labels.push(`${label} âœ…`);
      parents.push("Strengths");
      values.push(correct);
      colors.push(colorStrength);
    }

    if (incorrect > 0) {
      labels.push(`${label} âŒ`);
      parents.push("Weaknesses");
      values.push(incorrect);
      colors.push(colorWeakness);
    }
  });

  // Adiciona os grupos principais
  const totalStrengths = values
  .filter((_, i) => parents[i] === "Strengths")
  .reduce((a, b) => a + b, 0);

  const totalWeaknesses = values
  .filter((_, i) => parents[i] === "Weaknesses")
  .reduce((a, b) => a + b, 0);

  labels.unshift("Strengths", "Weaknesses");
  parents.unshift("", "");
  values.unshift(totalStrengths, totalWeaknesses);
  colors.unshift("lightblue", "lightcoral");

  const data = [{
    type: "treemap",
    labels,
    parents,
    values,
    marker: {
      colors,
      line: { width: 1 }
    },
    textinfo: "label+value",
    branchvalues: "total"
  }];

  const layout = {
    height: 500,
    margin: { t: 30, l: 0, r: 0, b: 0 }
  };

  Plotly.newPlot("voronoi-chart", data, layout, { responsive: true });
}
 </script>
 <script>
  function drawSankeyAccuracyChart(questions, answers, lang = "en") {
    const statusLabels = {
    en: { correct: "âœ… Correct", incorrect: "âŒ Incorrect" },
    pt: { correct: "âœ… Corretas", incorrect: "âŒ Incorretas" },
    es: { correct: "âœ… Correctas", incorrect: "âŒ Incorrectas" }
    };
    const areaLabels = {
     neuro: { pt: "ğŸ§  Neuro", en: "ğŸ§  Neuro", es: "ğŸ§  Neuro" },
     cardio: { pt: "â¤ï¸ Cardio", en: "â¤ï¸ Cardio", es: "â¤ï¸ Cardio" },
     infecto: { pt: "ğŸ¦  Infecto", en: "ğŸ¦  Infectious", es: "ğŸ¦  Infecciosas" },
     respiratorio: { pt: "ğŸ« RespiratÃ³rio", en: "ğŸ« Respiratory", es: "ğŸ« Respiratorio" },
     renal: { pt: "ğŸ©¸ Renal", en: "ğŸ©¸ Renal", es: "ğŸ©¸ Renal" },
     general: { pt: "ğŸ“š Geral", en: "ğŸ“š General", es: "ğŸ“š General" }
    };
    const labelsByLang = statusLabels[lang] || statusLabels["en"];
    const areaTopicStats = {};
    const labelIndexMap = {};
    const nodes = [];
    const links = [];

  // Etapa 1: Agrupar dados por Ã¡rea e tÃ³pico separando acertos e erros
  questions.forEach(q => {
    const area = q.area || "General";
    const topics = Array.isArray(q.topic) ? q.topic : [q.topic || "General"];
    const correct = answers[q.id] === q.correta;
    const status = correct ? "Correct" : "Incorrect";

    topics.forEach(topic => {
      const key = `${status}|${area}|${topic}`;
      if (!areaTopicStats[key]) areaTopicStats[key] = { status, area, topic, count: 0 };
      areaTopicStats[key].count++;
    });
  });

  // Etapa 2: Pegar os 10 tÃ³picos mais acertados e mais errados
  const statsArray = Object.values(areaTopicStats);
  const topCorrect = statsArray.filter(d => d.status === "Correct")
    .sort((a, b) => b.count - a.count).slice(0, 10);

  const topIncorrect = statsArray.filter(d => d.status === "Incorrect")
    .sort((a, b) => b.count - a.count).slice(0, 10);

  const topStats = [...topCorrect, ...topIncorrect];

  // FunÃ§Ã£o auxiliar para adicionar nÃ³s
  function getLabelIndex(label) {
    if (!(label in labelIndexMap)) {
      labelIndexMap[label] = nodes.length;
      nodes.push({ name: label });
    }
    return labelIndexMap[label];
  }

  // Etapa 3: Montar os links e nÃ³s com cores adaptadas
  topStats.forEach(({ status, area, topic, count }) => {
    const isCorrect = status === "Correct";
    const statusLabel = isCorrect ? labelsByLang.correct : labelsByLang.incorrect;
    const topicLabel = `${topic} ${isCorrect ? "âœ…" : "âŒ"}`;
    let areaKey = "general";
     if (typeof area === "string") {
      areaKey = area.toLowerCase();
     } else if (Array.isArray(area) && typeof area[0] === "string") {
      areaKey = area[0].toLowerCase();
}

const areaLabel = areaLabels[areaKey]?.[lang] || areaKey;
const source1 = getLabelIndex(statusLabel);
const source2 = getLabelIndex(areaLabel);
const target = getLabelIndex(topicLabel);


    // status â†’ Ã¡rea
    links.push({ source: source1, target: source2, value: count });

    // Ã¡rea â†’ tÃ³pico
    links.push({ source: source2, target: target, value: count });
  });

  const colorCorrect = "rgba(52, 152, 219, 0.8)";
  const colorIncorrect = "rgba(231, 76, 60, 0.8)";
  const colorLightCorrect = "rgba(52, 152, 219, 0.25)";
  const colorLightIncorrect = "rgba(231, 76, 60, 0.25)";
  const colorArea = "#cccccc";
  const data = [{
    type: "sankey",
    orientation: "h",
    node: {
      pad: 15,
      thickness: 20,
      line: { color: "black", width: 0.5 },
      label: nodes.map(n => n.name),
      color: nodes.map(n => {
        if (n.name === "âœ… Correct") return colorCorrect;
        if (n.name === "âŒ Incorrect") return colorIncorrect;
        if (n.name.endsWith("âœ…")) return colorLightCorrect;
        if (n.name.endsWith("âŒ")) return colorLightIncorrect;
        return colorArea;
      })
    },
    link: {
     source: links.map(l => l.source),
     target: links.map(l => l.target),
     value: links.map(l => l.value),
     color: links.map(l => {
      const srcLabel = nodes[l.source].name;
      if (srcLabel.startsWith("âœ…")) return colorCorrect;
      if (srcLabel.startsWith("âŒ")) return colorIncorrect;
      return "rgba(160,160,160,0.3)";
     }),
     label: links.map(l => {
      const src = nodes[l.source].name;
      const tgt = nodes[l.target].name;
      return `${src} â†’ ${tgt}: ${l.value}`;
     })
    }

  }];
  const estimatedHeight = Math.max(400, nodes.length * 28);
  const layout = {
  title: "Topic Accuracy Flow",
  font: { size: 12 },
  height: estimatedHeight,
  margin: { t: 40, l: 10, r: 10, b: 10 }
  };


  Plotly.newPlot("voronoi-topics-content", data, layout, { responsive: true });}
</script>
<script>
const translationsIndex = {
  en: {
    'btn-study': 'Study Mode',
    'btn-exam': 'Exam Mode',
    'btn-start': 'Start Quiz',
    'btn-settings': 'Settings',
    'settings-title': 'Settings',
    'label-select-difficulty': 'Select Difficulty:',
    'btn-save-config': 'Save Settings',
    'btn-cancel-config': 'Cancel',
    'label-easy': 'Easy',
    'label-medium': 'Medium',
    'label-hard': 'Hard',
    'label-very-hard': 'Very Hard',
    'label-select-specialty': 'Select Specialty:',
  },
  pt: {
    'btn-study': 'Modo Estudo',
    'btn-exam': 'Modo Simulado',
    'btn-start': 'Iniciar Simulado',
    'btn-settings': 'ConfiguraÃ§Ãµes',
    'settings-title': 'ConfiguraÃ§Ãµes',
    'label-select-difficulty': 'Selecionar Dificuldade:',
    'btn-save-config': 'Salvar',
    'btn-cancel-config': 'Cancelar',
    'label-easy': 'FÃ¡cil',
    'label-medium': 'MÃ©dio',
    'label-hard': 'DifÃ­cil',
    'label-very-hard': 'Muito DifÃ­cil',
    'label-select-specialty': 'Selecionar Especialidade:',
  },
  es: {
    'btn-study': 'Modo Estudio',
    'btn-exam': 'Modo Simulado',
    'btn-start': 'Comenzar Simulacro',
    'btn-settings': 'Configuraciones',
    'settings-title': 'Configuraciones',
    'label-select-difficulty': 'Seleccionar Dificultad:',
    'btn-save-config': 'Guardar',
    'btn-cancel-config': 'Cancelar',
    'label-easy': 'FÃ¡cil',
    'label-medium': 'Moderado',
    'label-hard': 'DifÃ­cil',
    'label-very-hard': 'Muy DifÃ­cil',
    'label-select-specialty': 'Seleccionar Especialidad:',
  }
};
function changeLanguage(lang) {
  localStorage.setItem('selectedLanguage', lang);
  window.location.reload();
}
window.addEventListener("DOMContentLoaded", () => {
  const lang = localStorage.getItem("selectedLanguage") || "en";
  const t = translationsIndex[lang] || translationsIndex.en;
  for (const id in t) {
  const el = document.getElementById(id);
  if (el) {
    if (el.tagName === "LABEL" && el.querySelector("input")) {
      // Se for um <label> com input, atualiza sÃ³ o texto apÃ³s o input
      const input = el.querySelector("input");
      el.innerHTML = "";
      el.appendChild(input);
      el.appendChild(document.createTextNode(" " + t[id]));
    } else {
      el.textContent = t[id];}
 }
}
});
</script>
</body>
</html>